--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")

--// Variables
local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local aiming = false
local espEnabled = false 
local teamCheck = false
local wallCheck = false
local aimPart = "Head"

local TELEPORT_THRESHOLD  = 30      
local ESP_GREEN_THRESHOLD = 8   

local COLOR_GREEN         = Color3.fromRGB(0, 255, 0)
local COLOR_RED           = Color3.fromRGB(255, 0, 0)
local COLOR_TEXT_OFF      = Color3.fromRGB(200, 200, 200) 
local COLOR_MAIN          = Color3.fromRGB(25, 25, 25) 
local COLOR_STROKE        = Color3.fromRGB(60, 60, 60)

--// UI Setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "Gemini_CenterTarget_v3"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

if pcall(function() screenGui.Parent = CoreGui end) then else
    screenGui.Parent = player:WaitForChild("PlayerGui")
end

--// UI Helpers
local function addCorner(obj, radius)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, radius or 6)
    c.Parent = obj
end

local function addStroke(obj, color, thickness)
    local s = Instance.new("UIStroke")
    s.Color = color or COLOR_STROKE
    s.Thickness = thickness or 1.5
    s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    s.Parent = obj
end

local function makeDraggable(obj)
    local dragging, inputStart, startPos
    obj.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            inputStart = input.Position
            startPos = obj.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - inputStart
            obj.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    obj.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
end

--// 1. Movable MENU Button
local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0, 50, 0, 50)
toggleBtn.Position = UDim2.new(0.5, -25, 0.1, 0)
toggleBtn.BackgroundColor3 = COLOR_MAIN
toggleBtn.Text = "MENU"
toggleBtn.TextColor3 = Color3.new(1,1,1)
toggleBtn.Font = Enum.Font.GothamBlack
toggleBtn.TextSize = 12
toggleBtn.Parent = screenGui
addCorner(toggleBtn, 25) 
addStroke(toggleBtn, Color3.new(1,1,1), 2)
makeDraggable(toggleBtn) 

--// 2. Main Menu
local menuFrame = Instance.new("Frame")
menuFrame.Size = UDim2.new(0, 240, 0, 360)
menuFrame.Position = UDim2.new(0.5, -120, 0.5, -180)
menuFrame.BackgroundColor3 = COLOR_MAIN
menuFrame.Visible = false
menuFrame.Parent = screenGui
addCorner(menuFrame, 12)
addStroke(menuFrame, COLOR_STROKE, 2)
makeDraggable(menuFrame)

local layout = Instance.new("UIListLayout")
layout.Parent = menuFrame
layout.Padding = UDim.new(0, 8)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center

local pad = Instance.new("UIPadding")
pad.PaddingTop = UDim.new(0, 45)
pad.Parent = menuFrame

local function createOption(text, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 200, 0, 38)
    btn.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    btn.Text = text
    btn.TextColor3 = COLOR_TEXT_OFF
    btn.Font = Enum.Font.GothamSemibold
    btn.TextSize = 14
    btn.Parent = menuFrame
    addCorner(btn, 6)
    btn.MouseButton1Click:Connect(function() callback(btn) end)
    return btn
end

createOption("Auto Aim: OFF", function(self)
    aiming = not aiming
    self.Text = "Auto Aim: " .. (aiming and "ON" or "OFF")
    self.TextColor3 = aiming and COLOR_GREEN or COLOR_TEXT_OFF
end)

createOption("ESP: OFF", function(self)
    espEnabled = not espEnabled
    self.Text = "ESP: " .. (espEnabled and "ON" or "OFF")
    self.TextColor3 = espEnabled and COLOR_GREEN or COLOR_TEXT_OFF
end)

createOption("Aim Part: Head", function(self)
    aimPart = (aimPart == "Head") and "HumanoidRootPart" or "Head"
    self.Text = "Aim Part: " .. aimPart
end)

createOption("Team Check: OFF", function(self)
    teamCheck = not teamCheck
    self.Text = "Team Check: " .. (teamCheck and "ON" or "OFF")
    self.TextColor3 = teamCheck and COLOR_GREEN or COLOR_TEXT_OFF
end)

createOption("Wall Check: OFF", function(self)
    wallCheck = not wallCheck
    self.Text = "Wall Check: " .. (wallCheck and "ON" or "OFF")
    self.TextColor3 = wallCheck and COLOR_GREEN or COLOR_TEXT_OFF
end)

--// 3. Teleport Button (15% Placement)
local tpContainer = Instance.new("Frame")
tpContainer.Size = UDim2.new(0, 210, 0, 48) 
tpContainer.Position = UDim2.new(1, -230, 0.15, 0) 
tpContainer.BackgroundColor3 = COLOR_MAIN
tpContainer.Parent = screenGui
addCorner(tpContainer, 8)
addStroke(tpContainer, COLOR_STROKE, 2)

local tpBtn = Instance.new("TextButton")
tpBtn.Size = UDim2.new(1, 0, 1, 0)
tpBtn.BackgroundTransparency = 1
tpBtn.Text = "CENTER TARGET"
tpBtn.TextColor3 = COLOR_TEXT_OFF
tpBtn.Font = Enum.Font.GothamBold
tpBtn.TextSize = 15 
tpBtn.Parent = tpContainer

--// Logic: Get person closest to center of screen
local function getCenterTarget()
    local closestPlr, shortestDist = nil, math.huge
    local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)

    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and plr.Character:FindFirstChild(aimPart) then
            if teamCheck and plr.Team == player.Team then continue end
            
            local targetPart = plr.Character[aimPart]
            local screenPos, onScreen = camera:WorldToViewportPoint(targetPart.Position)
            
            if onScreen then
                local distToCenter = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
                if distToCenter < shortestDist then
                    shortestDist = distToCenter
                    closestPlr = targetPart
                end
            end
        end
    end
    return closestPlr
end

toggleBtn.MouseButton1Click:Connect(function() menuFrame.Visible = not menuFrame.Visible end)

tpBtn.MouseButton1Click:Connect(function()
    local t = getCenterTarget()
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if t and hrp then
        local tHRP = t.Parent:FindFirstChild("HumanoidRootPart")
        if (tHRP.Position - hrp.Position).Magnitude <= TELEPORT_THRESHOLD then
            hrp.CFrame = tHRP.CFrame * CFrame.new(0, 0, 3.5)
        end
    end
end)

-- Render Loop
local espFolder = Instance.new("Folder", screenGui)
RunService.RenderStepped:Connect(function()
    local target = getCenterTarget()
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    
    -- Aiming (Only if Target is on Screen)
    if aiming and target then
        camera.CFrame = CFrame.new(camera.CFrame.Position, target.Position)
    end
    
    espFolder:ClearAllChildren()
    
    -- ESP & TP Logic
    if espEnabled then
        for _, plr in pairs(Players:GetPlayers()) do
            if plr ~= player and plr.Character then
                if teamCheck and plr.Team == player.Team then continue end
                
                local charPart = plr.Character:FindFirstChild(aimPart)
                local worldDist = charPart and hrp and (charPart.Position - hrp.Position).Magnitude or 999
                
                local h = Instance.new("Highlight", espFolder)
                h.Adornee = plr.Character
                h.FillColor = (worldDist <= ESP_GREEN_THRESHOLD) and COLOR_GREEN or COLOR_RED
                h.OutlineColor = Color3.new(1,1,1)
                h.FillTransparency = 0.5
            end
        end
    end
    
    -- Update TP Button for the person you are LOOKING AT
    if hrp and target then
        local d = (target.Position - hrp.Position).Magnitude
        tpBtn.Text = string.format("TP CENTER [%.1f]", d)
        
        if d <= TELEPORT_THRESHOLD then
            tpBtn.TextColor3 = COLOR_MAIN
            tpContainer.BackgroundColor3 = COLOR_GREEN
        else
            tpBtn.TextColor3 = COLOR_TEXT_OFF
            tpContainer.BackgroundColor3 = COLOR_MAIN
        end
    else
        tpBtn.Text = "LOOK AT TARGET"
        tpBtn.TextColor3 = Color3.fromRGB(100, 100, 100)
        tpContainer.BackgroundColor3 = COLOR_MAIN
    end
end)
